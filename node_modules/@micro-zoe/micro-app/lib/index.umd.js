!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).microApp={})}(this,(function(e){"use strict";const t="0.8.10",n="undefined"!=typeof window,s="undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:Function("return this")();function i(e){return"string"==typeof e}function r(e){return"boolean"==typeof e}function o(e){return"function"==typeof e}const a=Array.isArray;function c(e){return"[object Object]"===toString.call(e)}function l(e){return"[object Promise]"===toString.call(e)}function u(e){return o(e)&&0===e.name.indexOf("bound ")&&!e.hasOwnProperty("prototype")}const h=Object.defineProperty,p=Object.defineProperties,d=Object.prototype.hasOwnProperty;function m(e,t=null,...n){const s=t&&i(t)?` app ${t}:`:"";i(e)?console.error(`[micro-app]${s} ${e}`,...n):console.error(`[micro-app]${s}`,e,...n)}function f(e,t=null,...n){const s=t&&i(t)?` app ${t}:`:"";i(e)?console.warn(`[micro-app]${s} ${e}`,...n):console.warn(`[micro-app]${s}`,e,...n)}function _(e,...t){Promise.resolve().then(e.bind(null,...t))}function A(e){return e.startsWith("//")?`${location.protocol}${e}`:e}function b(e,t=null){if(!i(e)||!e)return"";try{const{origin:t,pathname:n,search:s}=new URL(A(e));if(/\.(\w+)$/.test(n))return`${t}${n}${s}`;const i=`${t}${n}/`.replace(/\/\/$/,"/");return/^https?:\/\//.test(i)?`${i}${s}`:""}catch(e){return m(e,t),""}}function g(e){return i(e)&&e?e.replace(/(^\d+)|([^\w\d-_])/gi,""):""}function w(e){const{origin:t,pathname:n}=new URL(e);if(/\.(\w+)$/.test(n)){const e=`${t}${n}`.split("/");return e.pop(),e.join("/")+"/"}return`${t}${n}/`.replace(/\/\/$/,"/")}function y(e,t){return!e||/^((((ht|f)tps?)|file):)?\/\//.test(e)||/^(data|blob):/.test(e)?e:new URL(e,w(A(t))).toString()}function E(e,t,n,s){let i=0;function r(){++i===e.length&&s&&s()}e.forEach(((e,s)=>{l(e)?e.then((e=>{t({data:e,index:s}),r()})).catch((e=>{n({error:e,index:s}),r()})):(t({data:e,index:s}),r())}))}const v=s.requestIdleCallback||function(e){const t=Date.now();return setTimeout((function(){e({didTimeout:!1,timeRemaining:()=>Math.max(0,50-(Date.now()-t))})}),50)};let N=null;function C(e){N=e}function R(e){N!==e&&(C(e),_((()=>{C(null)})))}function D(){return N}function M(){C(null)}function P(e,t){const n=document.createElement(e,t);return n.__MICRO_APP_NAME__&&delete n.__MICRO_APP_NAME__,n}function O(e,t,n){if(t.innerHTML="",n){const n=e.cloneNode(!0),s=document.createDocumentFragment();Array.from(n.childNodes).forEach((e=>{s.appendChild(e)})),t.appendChild(s)}else Array.from(e.childNodes).forEach((e=>{t.appendChild(e)}))}function S(e){return!e||/(^\d)|([^\w\d-_\u4e00-\u9fa5])/gi.test(e)}function I(e){return/^body$/i.test(e)||/^head$/i.test(e)||/^html$/i.test(e)}function L(e){return function(e){return"undefined"!=typeof ShadowRoot&&e instanceof ShadowRoot}(e)?e.host:e}function U(e){return e?e.replace(/^\s+|\s+$/g,""):""}function x(){return navigator.userAgent.indexOf("Firefox")>-1}var T,k,W,F;!function(e){e.NAME="name",e.URL="url"}(T||(T={})),function(e){e.NOT_LOADED="NOT_LOADED",e.LOADING_SOURCE_CODE="LOADING_SOURCE_CODE",e.LOAD_SOURCE_FINISHED="LOAD_SOURCE_FINISHED",e.LOAD_SOURCE_ERROR="LOAD_SOURCE_ERROR",e.MOUNTING="MOUNTING",e.MOUNTED="MOUNTED",e.UNMOUNT="UNMOUNT"}(k||(k={})),function(e){e.CREATED="created",e.BEFOREMOUNT="beforemount",e.MOUNTED="mounted",e.UNMOUNT="unmount",e.ERROR="error",e.BEFORESHOW="beforeshow",e.AFTERSHOW="aftershow",e.AFTERHIDDEN="afterhidden"}(W||(W={})),function(e){e.KEEP_ALIVE_SHOW="KEEP_ALIVE_SHOW",e.KEEP_ALIVE_HIDDEN="KEEP_ALIVE_HIDDEN"}(F||(F={}));const $="window,self,globalThis,Array,Object,String,Boolean,Math,Number,Symbol,Date,Promise,Function,Proxy,WeakMap,WeakSet,Set,Map,Reflect,Element,Node,Document,RegExp,Error,TypeError,JSON,isNaN,parseFloat,parseInt,performance,console,decodeURI,encodeURI,decodeURIComponent,encodeURIComponent,location,navigator,undefined";function B(e,t=null,n={}){return o(st.fetch)?st.fetch(e,n,t):fetch(e,n).then((e=>e.text()))}class H{static getInstance(){return this.instance||(this.instance=new H),this.instance}run(e,t){const n=e.name,s=e.ssrUrl||e.url;B(s,n,{cache:"no-cache"}).then((i=>{if(!i){const t="html is empty, please check in detail";return e.onerror(new Error(t)),m(t,n)}i=this.formatHTML(s,i,n),t(i,e)})).catch((t=>{m(`Failed to fetch data from ${e.url}, micro-app stop rendering`,n,t),e.onLoadError(t)}))}formatHTML(e,t,n){return this.processHtml(e,t,n,st.plugins).replace(/<head[^>]*>[\s\S]*?<\/head>/i,(e=>e.replace(/<head/i,"<micro-app-head").replace(/<\/head>/i,"</micro-app-head>"))).replace(/<body[^>]*>[\s\S]*?<\/body>/i,(e=>e.replace(/<body/i,"<micro-app-body").replace(/<\/body>/i,"</micro-app-body>")))}processHtml(e,t,n,s){var i;if(!s)return t;const r=[];return s.global&&r.push(...s.global),(null===(i=s.modules)||void 0===i?void 0:i[n])&&r.push(...s.modules[n]),r.length>0?r.reduce(((t,n)=>c(n)&&o(n.processHtml)?n.processHtml(t,e,n.options):t),t):t}}const K=/(^|\s+)(html|:root)(?=[\s>~[.#:]+|$)/,j=/(^|\s+)((html[\s>~]+body)|body)(?=[\s>~[.#:]+|$)/;function G(e,t){e=t?`${t} ${e}`:e;const n=new Error(e);throw n.reason=e,t&&(n.filename=t),n}class V{constructor(){this.cssText="",this.prefix="",this.baseURI="",this.linkPath="",this.result="",this.scopecssDisable=!1,this.scopecssDisableSelectors=[],this.scopecssDisableNextLine=!1,this.mediaRule=this.createMatcherForAtRuleWithChildRule(/^@media *([^{]+)/,"media"),this.supportsRule=this.createMatcherForAtRuleWithChildRule(/^@supports *([^{]+)/,"supports"),this.documentRule=this.createMatcherForAtRuleWithChildRule(/^@([-\w]+)?document *([^{]+)/,"document"),this.hostRule=this.createMatcherForAtRuleWithChildRule(/^@host\s*/,"host"),this.importRule=this.createMatcherForNoneBraceAtRule("import"),this.charsetRule=this.createMatcherForNoneBraceAtRule("charset"),this.namespaceRule=this.createMatcherForNoneBraceAtRule("namespace")}exec(e,t,n,s){return this.cssText=e,this.prefix=t,this.baseURI=n,this.linkPath=s||"",this.matchRules(),x()?decodeURIComponent(this.result):this.result}reset(){this.cssText=this.prefix=this.baseURI=this.linkPath=this.result="",this.scopecssDisable=this.scopecssDisableNextLine=!1,this.scopecssDisableSelectors=[]}matchRules(){for(this.matchLeadingSpaces(),this.matchComments();this.cssText.length&&"}"!==this.cssText.charAt(0)&&(this.matchAtRule()||this.matchStyleRule());)this.matchComments()}matchStyleRule(){const e=this.formatSelector(!0);return this.scopecssDisableNextLine=!1,e?(this.recordResult(e),this.matchComments(),this.styleDeclarations(),this.matchLeadingSpaces(),!0):G("selector missing",this.linkPath)}formatSelector(e){const t=this.commonMatch(/^([^{]+)/,e);return!!t&&t[0].replace(/(^|,[\n\s]*)([^,]+)/g,((e,t,n)=>(n=U(n),this.scopecssDisableNextLine||this.scopecssDisable&&(!this.scopecssDisableSelectors.length||this.scopecssDisableSelectors.includes(n))||K.test(n)||(n=j.test(n)?n.replace(j,this.prefix+" micro-app-body"):this.prefix+" "+n),t+n)))}styleDeclarations(){return this.matchOpenBrace()?(this.matchAllDeclarations(),!!this.matchCloseBrace()||G("Declaration missing '}'",this.linkPath)):G("Declaration missing '{'",this.linkPath)}matchAllDeclarations(){let e=this.commonMatch(/^(?:url\(["']?(?:[^)"'}]+)["']?\)|[^}/])*/,!0)[0];if(e&&(this.scopecssDisableNextLine||this.scopecssDisable&&!this.scopecssDisableSelectors.length||(e=e.replace(/url\(["']?([^)"']+)["']?\)/gm,((e,t)=>/^((data|blob):|#)/.test(t)||/^(https?:)?\/\//.test(t)?e:(/^((\.\.?\/)|[^/])/.test(t)&&this.linkPath&&(this.baseURI=function(e){const t=e.split("/");return t.pop(),A(t.join("/")+"/")}(this.linkPath)),`url("${y(t,this.baseURI)}")`)))),this.recordResult(e)),this.scopecssDisableNextLine=!1,this.cssText&&"}"!==this.cssText.charAt(0))return"/"===this.cssText.charAt(0)&&"*"===this.cssText.charAt(1)?this.matchComments():this.commonMatch(/\/+/),this.matchAllDeclarations()}matchAtRule(){return"@"===this.cssText[0]&&(this.scopecssDisableNextLine=!1,this.keyframesRule()||this.mediaRule()||this.customMediaRule()||this.supportsRule()||this.importRule()||this.charsetRule()||this.namespaceRule()||this.documentRule()||this.pageRule()||this.hostRule()||this.fontFaceRule())}keyframesRule(){if(!this.commonMatch(/^@([-\w]+)?keyframes\s*/))return!1;if(!this.commonMatch(/^([-\w]+)\s*/))return G("@keyframes missing name",this.linkPath);if(this.matchComments(),!this.matchOpenBrace())return G("@keyframes missing '{'",this.linkPath);for(this.matchComments();this.keyframeRule();)this.matchComments();return this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):G("@keyframes missing '}'",this.linkPath)}keyframeRule(){let e;const t=[];for(;e=this.commonMatch(/^((\d+\.\d+|\.\d+|\d+)%?|[a-z]+)\s*/);)t.push(e[1]),this.commonMatch(/^,\s*/);return!!t.length&&(this.styleDeclarations(),this.matchLeadingSpaces(),!0)}customMediaRule(){return!!this.commonMatch(/^@custom-media\s+(--[^\s]+)\s*([^{;]+);/)&&(this.matchLeadingSpaces(),!0)}pageRule(){return!!this.commonMatch(/^@page */)&&(this.formatSelector(!1),this.scopecssDisableNextLine=!1,this.commonHandlerForAtRuleWithSelfRule("page"))}fontFaceRule(){return!!this.commonMatch(/^@font-face\s*/)&&this.commonHandlerForAtRuleWithSelfRule("font-face")}createMatcherForAtRuleWithChildRule(e,t){return()=>!!this.commonMatch(e)&&(this.matchOpenBrace()?(this.matchComments(),this.matchRules(),this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):G(`@${t} missing '}'`,this.linkPath)):G(`@${t} missing '{'`,this.linkPath))}createMatcherForNoneBraceAtRule(e){const t=new RegExp("^@"+e+"\\s*([^;]+);");return()=>!!this.commonMatch(t)&&(this.matchLeadingSpaces(),!0)}commonHandlerForAtRuleWithSelfRule(e){return this.matchOpenBrace()?(this.matchAllDeclarations(),this.matchCloseBrace()?(this.matchLeadingSpaces(),!0):G(`@${e} missing '}'`,this.linkPath)):G(`@${e} missing '{'`,this.linkPath)}matchComments(){for(;this.matchComment(););}matchComment(){if("/"!==this.cssText.charAt(0)||"*"!==this.cssText.charAt(1))return!1;this.scopecssDisableNextLine=!1;let e=2;for(;""!==this.cssText.charAt(e)&&("*"!==this.cssText.charAt(e)||"/"!==this.cssText.charAt(e+1));)++e;if(e+=2,""===this.cssText.charAt(e-1))return G("End of comment missing",this.linkPath);let t=this.cssText.slice(2,e-2);if(this.recordResult(`/*${t}*/`),t=U(t.replace(/^\s*!/,"")),"scopecss-disable-next-line"===t)this.scopecssDisableNextLine=!0;else if(/^scopecss-disable/.test(t))if("scopecss-disable"===t)this.scopecssDisable=!0;else{this.scopecssDisable=!0;t.replace("scopecss-disable","").split(",").forEach((e=>{this.scopecssDisableSelectors.push(U(e))}))}else"scopecss-enable"===t&&(this.scopecssDisable=!1,this.scopecssDisableSelectors=[]);return this.cssText=this.cssText.slice(e),this.matchLeadingSpaces(),!0}commonMatch(e,t=!1){const n=e.exec(this.cssText);if(!n)return;const s=n[0];return this.cssText=this.cssText.slice(s.length),t||this.recordResult(s),n}matchOpenBrace(){return this.commonMatch(/^{\s*/)}matchCloseBrace(){return this.commonMatch(/^}/)}matchLeadingSpaces(){this.commonMatch(/^\s*/)}recordResult(e){x()?this.result+=encodeURIComponent(e):this.result+=e}}function q(e,t,n,s,i){if(!e.__MICRO_APP_HAS_SCOPED__){e.__MICRO_APP_HAS_SCOPED__=!0;let r=null;try{r=z.exec(e.textContent,n,s,i),z.reset()}catch(e){z.reset(),m("An error occurred while parsing CSS:\n",t,e)}r&&(e.textContent=r)}}let z;function Q(e,t){if(t.scopecss){const n=`${st.tagName}[name=${t.name}]`;if(z||(z=new V),e.textContent)q(e,t.name,n,t.url,e.__MICRO_APP_LINK_PATH__);else{const s=new MutationObserver((function(){s.disconnect(),e.textContent&&!e.hasAttribute("data-styled")&&q(e,t.name,n,t.url,e.__MICRO_APP_LINK_PATH__)}));s.observe(e,{childList:!0})}}return e}function J(e,t){Object.defineProperties(e,{currentTarget:{get:()=>t},srcElement:{get:()=>t},target:{get:()=>t}})}function X(e){const t=new CustomEvent("load");J(t,e),o(e.onload)?e.onload(t):e.dispatchEvent(t)}function Y(e){const t=new CustomEvent("error");J(t,e),o(e.onerror)?e.onerror(t):e.dispatchEvent(t)}const Z=new Map;function ee(e,t,n,s=!1){const i=e.getAttribute("rel");let r=e.getAttribute("href"),o=null;if("stylesheet"===i&&r){if(r=y(r,n.url),s)return{url:r,info:{code:"",isGlobal:e.hasAttribute("global")}};o=document.createComment(`link element with href=${r} move to micro-app-head as style element`),n.source.links.set(r,{code:"",placeholder:o,isGlobal:e.hasAttribute("global")})}else i&&["prefetch","preload","prerender","icon","apple-touch-icon"].includes(i)?s?o=document.createComment(`link element with rel=${i}${r?" & href="+r:""} removed by micro-app`):t.removeChild(e):r&&e.setAttribute("href",y(r,n.url));return s?{replaceComment:o}:o?t.replaceChild(o,e):void 0}function te(e,t,n){const s=Array.from(t.source.links.entries());E(s.map((([e])=>Z.has(e)?Z.get(e):B(e,t.name))),(e=>{!function(e,t,n,s,i){t.isGlobal&&!Z.has(e)&&Z.set(e,n);const r=P("style");r.textContent=n,r.__MICRO_APP_LINK_PATH__=e,r.setAttribute("data-origin-href",e),t.placeholder.parentNode?t.placeholder.parentNode.replaceChild(Q(r,i),t.placeholder):s.appendChild(Q(r,i));t.placeholder=null,t.code=n}(s[e.index][0],s[e.index][1],e.data,n,t)}),(e=>{m(e,t.name)}),(()=>{t.onLoad(e)}))}const ne=new WeakMap;function se(e,t,n){if(t instanceof HTMLStyleElement){if(t.hasAttribute("exclude")){const e=document.createComment("style element with exclude attribute ignored by micro-app");return ne.set(t,e),e}return n.scopecss&&!t.hasAttribute("ignore")?Q(t,n):t}if(t instanceof HTMLLinkElement){if(t.hasAttribute("exclude")||ye(t.getAttribute("href"),n.name)){const e=document.createComment("link element with exclude attribute ignored by micro-app");return ne.set(t,e),e}if(t.hasAttribute("ignore")||Ee(t.getAttribute("href"),n.name)||t.href&&o(st.excludeAssetFilter)&&st.excludeAssetFilter(t.href))return t;const{url:s,info:i,replaceComment:r}=ee(t,e,n,!0);if(s&&i){const e=P("style");return e.__MICRO_APP_LINK_PATH__=s,function(e,t,n,s,i){if(n.source.links.has(e))return i.textContent=n.source.links.get(e).code,Q(i,n),void _((()=>X(s)));if(Z.has(e)){const r=Z.get(e);return t.code=r,n.source.links.set(e,t),i.textContent=r,Q(i,n),void _((()=>X(s)))}B(e,n.name).then((r=>{t.code=r,n.source.links.set(e,t),t.isGlobal&&Z.set(e,r),i.textContent=r,Q(i,n),X(s)})).catch((e=>{m(e,n.name),Y(s)}))}(s,i,n,t,e),ne.set(t,e),e}return r?(ne.set(t,r),r):t}if(t instanceof HTMLScriptElement){if(t.src&&o(st.excludeAssetFilter)&&st.excludeAssetFilter(t.src))return t;const{replaceComment:s,url:i,info:r}=ge(t,e,n,!0)||{};if(i&&r){if(r.isExternal){const e=function(e,t,n,s){const i=()=>X(s);if(n.source.scripts.has(e)){const t=n.source.scripts.get(e);return!t.module&&_(i),Ne(e,n,t,!0,i)}if(be.has(e)){const s=be.get(e);return t.code=s,n.source.scripts.set(e,t),!t.module&&_(i),Ne(e,n,t,!0,i)}let r;r=n.inline||t.module?P("script"):document.createComment(`dynamic script with src='${e}' extract by micro-app`);return B(e,n.name).then((o=>{t.code=o,n.source.scripts.set(e,t),t.isGlobal&&be.set(e,o);try{o=De(e,n,o,t),n.inline||t.module?Ce(e,o,t.module,r,i):Re(o,t)}catch(t){console.error(`[micro-app from runDynamicScript] app ${n.name}: `,t,e)}!t.module&&X(s)})).catch((e=>{m(e,n.name),Y(s)})),r}(i,r,n,t);return ne.set(t,e),e}{const e=Ne(i,n,r,!0);return ne.set(t,e),e}}return s?(ne.set(t,s),s):t}return t}function ie(e,t,n,s,i){const r=function(e,t){var n,s;if(e===document.head)return null===(n=null==t?void 0:t.container)||void 0===n?void 0:n.querySelector("micro-app-head");if(e===document.body)return null===(s=null==t?void 0:t.container)||void 0===s?void 0:s.querySelector("micro-app-body");return null}(n,e);return r?i&&!r.contains(i)?_e.rawAppendChild.call(r,s):t!==_e.rawRemoveChild||r.contains(s)?re(t,r,s,i):n.contains(s)?t.call(n,s):s:re(t,n,s,i)}function re(e,t,n,s){return(i=e)===_e.rawAppend||i===_e.rawPrepend?e.call(t,n):e.call(t,n,s);var i}function oe(e){var t;return null!==(t=ne.get(e))&&void 0!==t?t:e}function ae(e,t,n,s){if(null==t?void 0:t.__MICRO_APP_NAME__){const i=Qe.get(t.__MICRO_APP_NAME__);return(null==i?void 0:i.container)?ie(i,s,e,se(e,t,i),n&&oe(n)):s===_e.rawAppend||s===_e.rawPrepend?s.call(e,t):s.call(e,t,n)}if(s===_e.rawAppend||s===_e.rawPrepend){const n=D();if(!(t instanceof Node)&&n){const i=Qe.get(n);if(null==i?void 0:i.container){if(e===document.head)return s.call(i.container.querySelector("micro-app-head"),t);if(e===document.body)return s.call(i.container.querySelector("micro-app-body"),t)}}return s.call(e,t)}return s.call(e,t,n)}function ce(){!function(){const e=_e.rawDocument;function t(t){var n,s,i;const r=D();return r&&t&&!I(t)&&e===this?null!==(i=null===(s=null===(n=Qe.get(r))||void 0===n?void 0:n.container)||void 0===s?void 0:s.querySelector(t))&&void 0!==i?i:null:_e.rawQuerySelector.call(this,t)}function n(t){var n,s,i;const r=D();return r&&t&&!I(t)&&e===this?null!==(i=null===(s=null===(n=Qe.get(r))||void 0===n?void 0:n.container)||void 0===s?void 0:s.querySelectorAll(t))&&void 0!==i?i:[]:_e.rawQuerySelectorAll.call(this,t)}Document.prototype.createElement=function(e,t){return le(_e.rawCreateElement.call(this,e,t))},Document.prototype.createElementNS=function(e,t,n){return le(_e.rawCreateElementNS.call(this,e,t,n))},Document.prototype.createDocumentFragment=function(){return le(_e.rawCreateDocumentFragment.call(this))},Document.prototype.querySelector=t,Document.prototype.querySelectorAll=n,Document.prototype.getElementById=function(e){if(!D()||S(e))return _e.rawGetElementById.call(this,e);try{return t.call(this,`#${e}`)}catch(t){return _e.rawGetElementById.call(this,e)}},Document.prototype.getElementsByClassName=function(e){if(!D()||S(e))return _e.rawGetElementsByClassName.call(this,e);try{return n.call(this,`.${e}`)}catch(t){return _e.rawGetElementsByClassName.call(this,e)}},Document.prototype.getElementsByTagName=function(e){var t;const s=D();if(!s||I(e)||S(e)||!(null===(t=Qe.get(s))||void 0===t?void 0:t.inline)&&/^script$/i.test(e))return _e.rawGetElementsByTagName.call(this,e);try{return n.call(this,e)}catch(t){return _e.rawGetElementsByTagName.call(this,e)}},Document.prototype.getElementsByName=function(e){if(!D()||S(e))return _e.rawGetElementsByName.call(this,e);try{return n.call(this,`[name=${e}]`)}catch(t){return _e.rawGetElementsByName.call(this,e)}}}(),Element.prototype.appendChild=function(e){return ae(this,e,null,_e.rawAppendChild)},Element.prototype.insertBefore=function(e,t){return ae(this,e,t,_e.rawInsertBefore)},Element.prototype.replaceChild=function(e,t){return ae(this,e,t,_e.rawReplaceChild)},Element.prototype.append=function(...e){let t=0;const n=e.length;for(;t<n;)ae(this,e[t],null,_e.rawAppend),t++},Element.prototype.prepend=function(...e){let t=e.length;for(;t>0;)ae(this,e[t-1],null,_e.rawPrepend),t--},Element.prototype.removeChild=function(e){if(null==e?void 0:e.__MICRO_APP_NAME__){const t=Qe.get(e.__MICRO_APP_NAME__);return(null==t?void 0:t.container)?ie(t,_e.rawRemoveChild,this,oe(e)):_e.rawRemoveChild.call(this,e)}return _e.rawRemoveChild.call(this,e)},Element.prototype.cloneNode=function(e){const t=_e.rawCloneNode.call(this,e);return this.__MICRO_APP_NAME__&&(t.__MICRO_APP_NAME__=this.__MICRO_APP_NAME__),t}}function le(e){const t=D();return t&&(e.__MICRO_APP_NAME__=t),e}let ue=!1;function he(){C(null),Document.prototype.createElement=_e.rawCreateElement,Document.prototype.createElementNS=_e.rawCreateElementNS,Document.prototype.createDocumentFragment=_e.rawCreateDocumentFragment,Document.prototype.querySelector=_e.rawQuerySelector,Document.prototype.querySelectorAll=_e.rawQuerySelectorAll,Document.prototype.getElementById=_e.rawGetElementById,Document.prototype.getElementsByClassName=_e.rawGetElementsByClassName,Document.prototype.getElementsByTagName=_e.rawGetElementsByTagName,Document.prototype.getElementsByName=_e.rawGetElementsByName,Element.prototype.appendChild=_e.rawAppendChild,Element.prototype.insertBefore=_e.rawInsertBefore,Element.prototype.replaceChild=_e.rawReplaceChild,Element.prototype.removeChild=_e.rawRemoveChild,Element.prototype.append=_e.rawAppend,Element.prototype.prepend=_e.rawPrepend,Element.prototype.cloneNode=_e.rawCloneNode}let pe=!1;class de{constructor(){this.appInstanceMap=Qe}static getInstance(){return this.instance||(this.instance=new de),this.instance}get(e){return this.appInstanceMap.get(e)}set(e,t){this.appInstanceMap.set(e,t)}getAll(){return Array.from(this.appInstanceMap.values())}clear(){this.appInstanceMap.clear()}}function me(){fe(),de.getInstance().getAll().forEach((e=>{e.container&&L(e.container).disconnectedCallback()})),!window.__MICRO_APP_UMD_MODE__&&de.getInstance().clear()}function fe(){window.__MICRO_APP_ENVIRONMENT__&&window.removeEventListener("unmount",me,!1)}const _e={};function Ae(){if(n){const e=Element.prototype.setAttribute,t=Element.prototype.appendChild,n=Element.prototype.insertBefore,s=Element.prototype.replaceChild,i=Element.prototype.removeChild,r=Element.prototype.append,o=Element.prototype.prepend,a=Element.prototype.cloneNode,c=Document.prototype.createElement,l=Document.prototype.createElementNS,u=Document.prototype.createDocumentFragment,h=Document.prototype.querySelector,p=Document.prototype.querySelectorAll,d=Document.prototype.getElementById,m=Document.prototype.getElementsByClassName,f=Document.prototype.getElementsByTagName,_=Document.prototype.getElementsByName,A=new Proxy(Image,{construct(e,t){const n=new e(...t);return n.__MICRO_APP_NAME__=D(),n}}),b=Function("return window")(),g=Function("return document")(),w="noModule"in document.createElement("script"),y=b.addEventListener,E=b.removeEventListener,v=b.setInterval,N=b.setTimeout,C=b.clearInterval,R=b.clearTimeout,M=g.addEventListener,O=g.removeEventListener;window.__MICRO_APP_BASE_APPLICATION__=!0,Object.assign(_e,{rawSetAttribute:e,rawAppendChild:t,rawInsertBefore:n,rawReplaceChild:s,rawRemoveChild:i,rawAppend:r,rawPrepend:o,rawCloneNode:a,rawCreateElement:c,rawCreateElementNS:l,rawCreateDocumentFragment:u,rawQuerySelector:h,rawQuerySelectorAll:p,rawGetElementById:d,rawGetElementsByClassName:m,rawGetElementsByTagName:f,rawGetElementsByName:_,ImageProxy:A,rawWindow:b,rawDocument:g,supportModuleScript:w,rawWindowAddEventListener:y,rawWindowRemoveEventListener:E,rawSetInterval:v,rawSetTimeout:N,rawClearInterval:C,rawClearTimeout:R,rawDocumentAddEventListener:M,rawDocumentRemoveEventListener:O}),function(){if(!pe){pe=!0;const e=P("style");_e.rawSetAttribute.call(e,"type","text/css"),e.textContent=`\n${st.tagName}, micro-app-body { display: block; } \nmicro-app-head { display: none; }`,_e.rawDocument.head.appendChild(e)}}(),fe(),window.__MICRO_APP_ENVIRONMENT__&&window.addEventListener("unmount",me,!1)}}const be=new Map;function ge(e,t,n,s=!1){let i=null,r=e.getAttribute("src");if(r&&(r=y(r,n.url)),e.hasAttribute("exclude")||ye(r,n.name))i=document.createComment("script element with exclude attribute removed by micro-app");else{if(e.type&&!["text/javascript","text/ecmascript","application/javascript","application/ecmascript","module","systemjs-module","systemjs-importmap"].includes(e.type)||e.hasAttribute("ignore")||Ee(r,n.name))return null;if(_e.supportModuleScript&&e.noModule||!_e.supportModuleScript&&"module"===e.type)i=document.createComment((e.noModule?"noModule":"module")+" script ignored by micro-app");else if(r){const t={code:"",isExternal:!0,isDynamic:s,async:e.hasAttribute("async"),defer:e.defer||"module"===e.type,module:"module"===e.type,isGlobal:e.hasAttribute("global")};if(s)return{url:r,info:t};n.source.scripts.set(r,t),i=document.createComment(`script with src='${r}' extract by micro-app`)}else if(e.textContent){const t="inline-"+Math.random().toString(36).substr(2,15),r={code:e.textContent,isExternal:!1,isDynamic:s,async:!1,defer:"module"===e.type,module:"module"===e.type};if(s)return{url:t,info:r};n.source.scripts.set(t,r),i=document.createComment("inline script extract by micro-app")}else s||(i=document.createComment("script element removed by micro-app"))}return s?{replaceComment:i}:t.replaceChild(i,e)}function we(e){var t,n,s;return[...(null===(t=st.plugins)||void 0===t?void 0:t.global)||[],...(null===(s=null===(n=st.plugins)||void 0===n?void 0:n.modules)||void 0===s?void 0:s[e])||[]]}function ye(e,t){if(!e)return!1;return(we(t)||[]).some((t=>!!t.excludeChecker&&t.excludeChecker(e)))}function Ee(e,t){if(!e)return!1;return(we(t)||[]).some((t=>!!t.ignoreChecker&&t.ignoreChecker(e)))}function ve(e,t){const n=Array.from(t.source.scripts.entries()),s=[],i=[];for(const[e,r]of n)if(r.isExternal){const n=be.get(e);n?r.code=n:(!r.defer&&!r.async||t.isPrefetch)&&(s.push(B(e,t.name)),i.push([e,r]))}s.length?E(s,(e=>{!function(e,t,n){t.isGlobal&&!be.has(e)&&be.set(e,n);t.code=n}(i[e.index][0],i[e.index][1],e.data)}),(e=>{m(e,t.name)}),(()=>{t.onLoad(e)})):t.onLoad(e)}function Ne(e,t,n,s,i){var r;try{const o=De(e,t,n.code,n);if(t.inline||n.module){const a=P("script");if(Ce(e,o,n.module,a,i),s)return a;null===(r=t.container)||void 0===r||r.querySelector("micro-app-body").appendChild(a)}else if(Re(o,n),s)return document.createComment("dynamic script extract by micro-app")}catch(e){console.error(`[micro-app from runScript] app ${t.name}: `,e)}}function Ce(e,t,n,s,i){if(n){const e=new Blob([t],{type:"text/javascript"});s.src=URL.createObjectURL(e),s.setAttribute("type","module"),i&&(i.moduleCount&&i.moduleCount--,s.onload=i.bind(s,0===i.moduleCount))}else s.textContent=t;e.startsWith("inline-")||s.setAttribute("data-origin-src",e)}function Re(e,t){t.code2Function||(t.code2Function=new Function(e)),t.code2Function.call(window)}function De(e,t,n,s){return c(st.plugins)&&(n=function(e,t,n,s,i){var r;const o=Me(s.global,t,e,i);return Me(null===(r=s.modules)||void 0===r?void 0:r[n],o,e,i)}(e,n,t.name,st.plugins,s)),t.sandBox&&!s.module?(_e.rawWindow.__MICRO_APP_PROXY_WINDOW__=t.sandBox.proxyWindow,`;(function(proxyWindow){with(proxyWindow.__MICRO_APP_WINDOW__){(function(${$}){;${n}\n}).call(proxyWindow,${$})}})(window.__MICRO_APP_PROXY_WINDOW__);`):n}function Me(e,t,n,s){return a(e)?e.reduce(((e,t)=>c(t)&&o(t.loader)?t.loader(e,n,t.options,s):e),t):t}function Pe(e,t,n){const s=Array.from(e.children);s.length&&s.forEach((e=>{Pe(e,t)}));for(const n of s)n instanceof HTMLLinkElement?n.hasAttribute("exclude")||ye(n.getAttribute("href"),t.name)?e.replaceChild(document.createComment("link element with exclude attribute ignored by micro-app"),n):n.hasAttribute("ignore")||Ee(n.getAttribute("href"),t.name)?n.hasAttribute("href")&&n.setAttribute("href",y(n.getAttribute("href"),t.url)):ee(n,e,t):n instanceof HTMLStyleElement?n.hasAttribute("exclude")?e.replaceChild(document.createComment("style element with exclude attribute ignored by micro-app"),n):t.scopecss&&!n.hasAttribute("ignore")&&Q(n,t):n instanceof HTMLScriptElement?ge(n,e,t):n instanceof HTMLMetaElement||n instanceof HTMLTitleElement?e.removeChild(n):n instanceof HTMLImageElement&&n.hasAttribute("src")&&n.setAttribute("src",y(n.getAttribute("src"),t.url))}function Oe(e,t){const n=function(e){const t=P("div");return t.innerHTML=e,t}(e),s=n.querySelector("micro-app-head"),i=n.querySelector("micro-app-body");if(!s||!i){const e=`element ${s?"body":"head"} is missing`;return t.onerror(new Error(e)),m(e,t.name)}Pe(n,t),t.source.links.size?te(n,t,s):t.onLoad(n),t.source.scripts.size?ve(n,t):t.onLoad(n)}const Se=new class{constructor(){this.eventList=new Map}isLegalName(e){return!!e||(m("event-center: Invalid name"),!1)}on(e,t,n=!1){if(this.isLegalName(e)){if(!o(t))return m("event-center: Invalid callback function");let s=this.eventList.get(e);s?n&&Object.getOwnPropertyNames(s.data).length&&t(s.data):(s={data:{},callbacks:new Set},this.eventList.set(e,s)),s.callbacks.add(t)}}off(e,t){if(this.isLegalName(e)){const n=this.eventList.get(e);n&&(o(t)?n.callbacks.delete(t):n.callbacks.clear())}}dispatch(e,t){if(this.isLegalName(e)){if(!c(t))return m("event-center: data must be object");let n=this.eventList.get(e);if(n){if(n.data!==t){n.data=t;for(const e of n.callbacks)e(t)}}else n={data:t,callbacks:new Set},this.eventList.set(e,n)}}getData(e){var t;const n=this.eventList.get(e);return null!==(t=null==n?void 0:n.data)&&void 0!==t?t:null}};function Ie(e,t){return i(e)&&e?t?`__from_base_app_${e}__`:`__from_micro_app_${e}__`:""}class Le{addGlobalDataListener(e,t){const n=this.appName;n&&(e.__APP_NAME__=n,e.__AUTO_TRIGGER__=t),Se.on("global",e,t)}removeGlobalDataListener(e){o(e)&&Se.off("global",e)}setGlobalData(e){M(),Se.dispatch("global",e)}getGlobalData(){return Se.getData("global")}clearGlobalDataListener(){const e=this.appName,t=Se.eventList.get("global");if(t)for(const n of t.callbacks)(e&&e===n.__APP_NAME__||!e&&!n.__APP_NAME__)&&t.callbacks.delete(n)}}class Ue extends Le{addDataListener(e,t,n){Se.on(Ie(g(e),!1),t,n)}removeDataListener(e,t){o(t)&&Se.off(Ie(g(e),!1),t)}getData(e,t=!1){return Se.getData(Ie(g(e),t))}setData(e,t){Se.dispatch(Ie(g(e),!0),t)}clearDataListener(e){Se.off(Ie(g(e),!1))}}class xe extends Le{constructor(e){super(),this.appName=g(e),!this.appName&&m(`Invalid appName ${e}`)}addDataListener(e,t){e.__AUTO_TRIGGER__=t,Se.on(Ie(this.appName,!0),e,t)}removeDataListener(e){o(e)&&Se.off(Ie(this.appName,!0),e)}getData(){return Se.getData(Ie(this.appName,!0))}dispatch(e){M(),Se.dispatch(Ie(this.appName,!1),e);const t=Qe.get(this.appName);if((null==t?void 0:t.container)&&c(e)){const n=new CustomEvent("datachange",{detail:{data:e}});L(t.container).dispatchEvent(n)}}clearDataListener(){Se.off(Ie(this.appName,!0))}}function Te(e,t){if(t.__MICRO_APP_BOUND_WINDOW_FUNCTION__)return t.__MICRO_APP_BOUND_WINDOW_FUNCTION__;if(!function(e){var t;if(r(e.__MICRO_APP_IS_CONSTRUCTOR__))return e.__MICRO_APP_IS_CONSTRUCTOR__;const n=e.toString(),s=(null===(t=e.prototype)||void 0===t?void 0:t.constructor)===e&&Object.getOwnPropertyNames(e.prototype).length>1||/^function\s+[A-Z]/.test(n)||/^class\s+/.test(n);return e.__MICRO_APP_IS_CONSTRUCTOR__=s}(t)&&!function(e){return r(e.__MICRO_APP_IS_BOUND_FUNCTION__)?e.__MICRO_APP_IS_BOUND_FUNCTION__:e.__MICRO_APP_IS_BOUND_FUNCTION__=u(e)}(t)){const n=t.bind(e);for(const e in t)n[e]=t[e];return t.hasOwnProperty("prototype")&&h(n,"prototype",{value:t.prototype,configurable:!0,enumerable:!1,writable:!0}),t.__MICRO_APP_BOUND_WINDOW_FUNCTION__=n}return t}const ke=new Map;let We=!1;const Fe=new Map;function $e(){const{rawDocument:e,rawDocumentAddEventListener:t,rawDocumentRemoveEventListener:n}=_e;!We&&function(){if(We=!0,Object.getOwnPropertyDescriptor(document,"onclick"))return f("Cannot redefine document property onclick");const e=document.onclick;document.onclick=null;let t=!1;function n(e){ke.forEach((t=>{o(t)&&t.call(document,e)}))}h(document,"onclick",{configurable:!0,enumerable:!0,get(){const e=D();return e?ke.get(e):ke.get("base")},set(e){const s=D();s?ke.set(s,e):ke.set("base",e),!t&&o(e)&&(t=!0,_e.rawDocumentAddEventListener.call(_e.rawDocument,"click",n,!1))}}),e&&(document.onclick=e)}(),document.addEventListener=function(n,s,i){var r;const o=D();if(o&&(!(null===(r=Qe.get(o))||void 0===r?void 0:r.umdMode)||!u(s))){const e=Fe.get(o);if(e){const t=e.get(n);t?t.add(s):e.set(n,new Set([s]))}else Fe.set(o,new Map([[n,new Set([s])]]));s&&(s.__MICRO_APP_MARK_OPTIONS__=i)}t.call(e,n,s,i)},document.removeEventListener=function(t,s,i){var r;const o=D();if(o&&(!(null===(r=Qe.get(o))||void 0===r?void 0:r.umdMode)||!u(s))){const e=Fe.get(o);if(e){const n=e.get(t);(null==n?void 0:n.size)&&n.has(s)&&n.delete(s)}}n.call(e,t,s,i)}}const Be=["unmount","appstate-change"];function He(e,t){return Be.includes(e)?`${e}-${t.__MICRO_APP_NAME__}`:e}const Ke=["System","__cjsWrapper"],je=["location"],Ge=["window","self","globalThis"];class Ve{constructor(e,t){this.scopeProperties=["webpackJsonp","Vue"],this.escapeProperties=[],this.injectedKeys=new Set,this.escapeKeys=new Set,this.active=!1,this.microAppWindow={},this.getSpecialProperties(e),this.proxyWindow=this.createProxyWindow(e),this.initMicroAppWindow(this.microAppWindow,e,t),Object.assign(this,function(e){const t=e.__MICRO_APP_NAME__,n=new Map,s=new Map,i=new Map,{rawWindow:r,rawDocument:o,rawWindowAddEventListener:a,rawWindowRemoveEventListener:c,rawSetInterval:l,rawSetTimeout:u,rawClearInterval:h,rawClearTimeout:p,rawDocumentRemoveEventListener:d}=_e;e.addEventListener=function(t,s,i){t=He(t,e);const o=n.get(t);o?o.add(s):n.set(t,new Set([s])),s&&(s.__MICRO_APP_MARK_OPTIONS__=i),a.call(r,t,s,i)},e.removeEventListener=function(t,s,i){t=He(t,e);const o=n.get(t);(null==o?void 0:o.size)&&o.has(s)&&o.delete(s),c.call(r,t,s,i)},e.setInterval=function(e,t,...n){const i=l.call(r,e,t,...n);return s.set(i,{handler:e,timeout:t,args:n}),i},e.setTimeout=function(e,t,...n){const s=u.call(r,e,t,...n);return i.set(s,{handler:e,timeout:t,args:n}),s},e.clearInterval=function(e){s.delete(e),h.call(r,e)},e.clearTimeout=function(e){i.delete(e),p.call(r,e)};const m=new Map,f=new Map;let _,A=new Map,b=new Map;return{recordUmdEffect:()=>{n.forEach(((e,t)=>{e.size&&m.set(t,new Set(e))})),s.size&&(A=new Map(s)),i.size&&(b=new Map(i)),_=ke.get(t);const e=Fe.get(t);e&&e.forEach(((e,t)=>{e.size&&f.set(t,new Set(e))}))},rebuildUmdEffect:()=>{m.forEach(((t,n)=>{for(const s of t)e.addEventListener(n,s,null==s?void 0:s.__MICRO_APP_MARK_OPTIONS__)})),A.forEach((t=>{e.setInterval(t.handler,t.timeout,...t.args)})),b.forEach((t=>{e.setTimeout(t.handler,t.timeout,...t.args)})),_&&ke.set(t,_),C(t),f.forEach(((e,t)=>{for(const n of e)document.addEventListener(t,n,null==n?void 0:n.__MICRO_APP_MARK_OPTIONS__)})),C(null)},releaseEffect:()=>{n.size&&(n.forEach(((e,t)=>{for(const n of e)c.call(r,t,n)})),n.clear()),s.size&&(s.forEach(((e,t)=>{h.call(r,t)})),s.clear()),i.size&&(i.forEach(((e,t)=>{p.call(r,t)})),i.clear()),ke.delete(t);const e=Fe.get(t);e&&(e.forEach(((e,t)=>{for(const n of e)d.call(o,t,n)})),e.clear())}}}(this.microAppWindow))}start(e){this.active||(this.active=!0,this.microAppWindow.__MICRO_APP_BASE_ROUTE__=this.microAppWindow.__MICRO_APP_BASE_URL__=e,_e.rawWindow._babelPolyfill&&(_e.rawWindow._babelPolyfill=!1),1==++Ve.activeCount&&($e(),ce()))}stop(e){this.active&&(this.active=!1,this.releaseEffect(),this.microAppWindow.microApp.clearDataListener(),this.microAppWindow.microApp.clearGlobalDataListener(),e||(this.injectedKeys.forEach((e=>{Reflect.deleteProperty(this.microAppWindow,e)})),this.injectedKeys.clear(),this.escapeKeys.forEach((e=>{Reflect.deleteProperty(_e.rawWindow,e)})),this.escapeKeys.clear()),0==--Ve.activeCount&&(document.addEventListener=_e.rawDocumentAddEventListener,document.removeEventListener=_e.rawDocumentRemoveEventListener,he()))}recordUmdSnapshot(){this.microAppWindow.__MICRO_APP_UMD_MODE__=!0,this.recordUmdEffect(),function(e){const t=e.appName;e.umdDataListeners={global:new Set,normal:new Set};const n=Se.eventList.get("global");if(n)for(const s of n.callbacks)t===s.__APP_NAME__&&e.umdDataListeners.global.add(s);const s=Se.eventList.get(Ie(t,!0));s&&(e.umdDataListeners.normal=new Set(s.callbacks))}(this.microAppWindow.microApp),this.recordUmdInjectedValues=new Map,this.injectedKeys.forEach((e=>{this.recordUmdInjectedValues.set(e,Reflect.get(this.microAppWindow,e))}))}rebuildUmdSnapshot(){this.recordUmdInjectedValues.forEach(((e,t)=>{Reflect.set(this.proxyWindow,t,e)})),this.rebuildUmdEffect(),function(e){for(const t of e.umdDataListeners.global)e.addGlobalDataListener(t,t.__AUTO_TRIGGER__);for(const t of e.umdDataListeners.normal)e.addDataListener(t,t.__AUTO_TRIGGER__)}(this.microAppWindow.microApp)}getSpecialProperties(e){var t;c(st.plugins)&&(this.commonActionForSpecialProperties(st.plugins.global),this.commonActionForSpecialProperties(null===(t=st.plugins.modules)||void 0===t?void 0:t[e]))}commonActionForSpecialProperties(e){if(a(e))for(const t of e)c(t)&&(a(t.scopeProperties)&&(this.scopeProperties=this.scopeProperties.concat(t.scopeProperties)),a(t.escapeProperties)&&(this.escapeProperties=this.escapeProperties.concat(t.escapeProperties)))}createProxyWindow(e){const t=_e.rawWindow,n=new Map;return new Proxy(this.microAppWindow,{get:(n,s)=>{if(R(e),Reflect.has(n,s)||i(s)&&/^__MICRO_APP_/.test(s)||this.scopeProperties.includes(s))return Reflect.get(n,s);const r=Reflect.get(t,s);return o(r)?Te(t,r):r},set:(e,n,s)=>{if(this.active){if(je.includes(n))Reflect.set(t,n,s);else if(d.call(e,n)||!d.call(t,n)||this.scopeProperties.includes(n))Reflect.set(e,n,s),this.injectedKeys.add(n);else{const i=Object.getOwnPropertyDescriptor(t,n),{configurable:r,enumerable:o,writable:a,set:c}=i;h(e,n,{value:s,configurable:r,enumerable:o,writable:null!=a?a:!!c}),this.injectedKeys.add(n)}(this.escapeProperties.includes(n)||Ke.includes(n)&&!Reflect.has(t,n))&&!this.scopeProperties.includes(n)&&(Reflect.set(t,n,s),this.escapeKeys.add(n))}return!0},has:(e,n)=>this.scopeProperties.includes(n)?n in e:n in e||n in t,getOwnPropertyDescriptor:(e,s)=>{if(d.call(e,s))return n.set(s,"target"),Object.getOwnPropertyDescriptor(e,s);if(d.call(t,s)){n.set(s,"rawWindow");const e=Object.getOwnPropertyDescriptor(t,s);return e&&!e.configurable&&(e.configurable=!0),e}},defineProperty:(e,s,i)=>"rawWindow"===n.get(s)?Reflect.defineProperty(t,s,i):Reflect.defineProperty(e,s,i),ownKeys:e=>Reflect.ownKeys(t).concat(Reflect.ownKeys(e)).filter((function(e){return!(e in this)&&(this[e]=!0)}),Object.create(null)),deleteProperty:(e,n)=>!d.call(e,n)||(this.injectedKeys.has(n)&&this.injectedKeys.delete(n),this.escapeKeys.has(n)&&Reflect.deleteProperty(t,n),Reflect.deleteProperty(e,n))})}initMicroAppWindow(e,t,n){e.__MICRO_APP_ENVIRONMENT__=!0,e.__MICRO_APP_NAME__=t,e.__MICRO_APP_PUBLIC_PATH__=w(n),e.__MICRO_APP_WINDOW__=e,e.microApp=Object.assign(new xe(t),{removeDomScope:M,pureCreateElement:P}),e.rawWindow=_e.rawWindow,e.rawDocument=_e.rawDocument,e.hasOwnProperty=t=>d.call(e,t)||d.call(_e.rawWindow,t),this.setMappingPropertiesWithRawDescriptor(e),this.setHijackProperties(e,t)}setMappingPropertiesWithRawDescriptor(e){let t,n;const s=_e.rawWindow;s===s.parent?t=n=this.proxyWindow:(t=s.top,n=s.parent),h(e,"top",this.createDescriptorForMicroAppWindow("top",t)),h(e,"parent",this.createDescriptorForMicroAppWindow("parent",n)),Ge.forEach((t=>{h(e,t,this.createDescriptorForMicroAppWindow(t,this.proxyWindow))}))}createDescriptorForMicroAppWindow(e,t){const{configurable:n=!0,enumerable:s=!0,writable:i,set:r}=Object.getOwnPropertyDescriptor(_e.rawWindow,e)||{writable:!0};return{value:t,configurable:n,enumerable:s,writable:null!=i?i:!!r}}setHijackProperties(e,t){let n,s;p(e,{document:{get:()=>(R(t),_e.rawDocument),configurable:!1,enumerable:!0},eval:{get:()=>(R(t),n||eval),set:e=>{n=e},configurable:!0,enumerable:!1},Image:{get:()=>(R(t),s||_e.ImageProxy),set:e=>{s=e},configurable:!0,enumerable:!1}})}}function qe(e,t,n,s){var i;if(!e)return m(`element does not exist in lifecycle ${n}`,t);e=L(e),M();const r=Object.assign({name:t,container:e},s&&{error:s}),a=new CustomEvent(n,{detail:r});!function(e,t){Object.defineProperties(e,{currentTarget:{get:()=>t},target:{get:()=>t}})}(a,e),o(null===(i=st.lifeCycles)||void 0===i?void 0:i[n])&&st.lifeCycles[n](a),e.dispatchEvent(a)}function ze(e,t,n={}){const s=new CustomEvent(`${e}-${t}`,{detail:n});window.dispatchEvent(s)}Ve.activeCount=0;const Qe=new Map;class Je{constructor({name:e,url:t,ssrUrl:n,container:s,inline:i,scopecss:r,useSandbox:o,baseroute:a}){this.state=k.NOT_LOADED,this.keepAliveState=null,this.keepAliveContainer=null,this.loadSourceLevel=0,this.umdHookMount=null,this.umdHookUnmount=null,this.libraryName=null,this.umdMode=!1,this.isPrefetch=!1,this.prefetchResolve=null,this.container=null,this.baseroute="",this.sandBox=null,this.container=null!=s?s:null,this.inline=null!=i&&i,this.baseroute=null!=a?a:"",this.ssrUrl=null!=n?n:"",this.name=e,this.url=t,this.useSandbox=o,this.scopecss=this.useSandbox&&r,this.source={links:new Map,scripts:new Map},this.loadSourceCode(),this.useSandbox&&(this.sandBox=new Ve(e,t))}loadSourceCode(){this.state=k.LOADING_SOURCE_CODE,H.getInstance().run(this,Oe)}onLoad(e){var t;2==++this.loadSourceLevel&&(this.source.html=e,this.isPrefetch?(null===(t=this.prefetchResolve)||void 0===t||t.call(this),this.prefetchResolve=null):k.UNMOUNT!==this.state&&(this.state=k.LOAD_SOURCE_FINISHED,this.mount()))}onLoadError(e){this.loadSourceLevel=-1,this.prefetchResolve&&(this.prefetchResolve(),this.prefetchResolve=null),k.UNMOUNT!==this.state&&(this.onerror(e),this.state=k.LOAD_SOURCE_ERROR)}mount(e,t,n){var s,i,a;if(r(t)&&t!==this.inline&&(this.inline=t),this.container=null!==(s=this.container)&&void 0!==s?s:e,this.baseroute=null!=n?n:this.baseroute,2!==this.loadSourceLevel)return void(this.state=k.LOADING_SOURCE_CODE);let c;if(qe(this.container,this.name,W.BEFOREMOUNT),this.state=k.MOUNTING,O(this.source.html,this.container,!this.umdMode),null===(i=this.sandBox)||void 0===i||i.start(this.baseroute),this.umdMode){null===(a=this.sandBox)||void 0===a||a.rebuildUmdSnapshot();try{c=this.umdHookMount()}catch(e){m("an error occurred in the mount function \n",this.name,e)}this.handleMounted(c)}else{let e=!1;!function(e,t,n){const s=Array.from(e.entries()),i=[],r=[];for(const[e,o]of s)o.isDynamic||(o.defer||o.async?(o.isExternal&&!o.code?i.push(B(e,t.name)):i.push(o.code),r.push([e,o]),o.module&&(n.moduleCount=n.moduleCount?++n.moduleCount:1)):(Ne(e,t,o,!1),n(!1)));i.length?E(i,(e=>{const t=r[e.index][1];t.code=t.code||e.data}),(e=>{n.errorCount=n.errorCount?++n.errorCount:1,m(e,t.name)}),(()=>{r.forEach((([e,s])=>{s.code&&(Ne(e,t,s,!1,n),!s.module&&n(!1))})),n(void 0===n.moduleCount||n.errorCount===i.length)})):n(!0)}(this.source.scripts,this,(t=>{var n;if(!this.umdMode){const{mount:e,unmount:t}=this.getUmdLibraryHooks();if(o(e)&&o(t)){this.umdHookMount=e,this.umdHookUnmount=t,this.umdMode=!0,null===(n=this.sandBox)||void 0===n||n.recordUmdSnapshot();try{c=this.umdHookMount()}catch(e){m("an error occurred in the mount function \n",this.name,e)}}}e||!0!==t&&!this.umdMode||(e=!0,this.handleMounted(c))}))}}handleMounted(e){l(e)?e.then((()=>this.dispatchMountedEvent())).catch((e=>this.onerror(e))):this.dispatchMountedEvent()}dispatchMountedEvent(){k.UNMOUNT!==this.state&&(this.state=k.MOUNTED,qe(this.container,this.name,W.MOUNTED))}unmount(e,t){let n;if(this.state===k.LOAD_SOURCE_ERROR&&(e=!0),this.state=k.UNMOUNT,this.keepAliveState=null,this.keepAliveContainer=null,this.umdHookUnmount)try{n=this.umdHookUnmount()}catch(e){m("an error occurred in the unmount function \n",this.name,e)}ze("unmount",this.name),this.handleUnmounted(e,n,t)}handleUnmounted(e,t,n){l(t)?t.then((()=>this.actionsForUnmount(e,n))).catch((()=>this.actionsForUnmount(e,n))):this.actionsForUnmount(e,n)}actionsForUnmount(e,t){var n;e?this.actionsForCompletelyDestroy():this.umdMode&&this.container.childElementCount&&O(this.container,this.source.html,!1),null===(n=this.sandBox)||void 0===n||n.stop(this.umdMode),et().length||(ue=!1,Element.prototype.setAttribute=_e.rawSetAttribute),qe(this.container,this.name,W.UNMOUNT),this.container.innerHTML="",this.container=null,t&&t()}actionsForCompletelyDestroy(){!this.useSandbox&&this.umdMode&&delete window[this.libraryName],Qe.delete(this.name)}hiddenKeepAliveApp(){const e=this.container;O(this.container,this.keepAliveContainer?this.keepAliveContainer:this.keepAliveContainer=document.createElement("div"),!1),this.container=this.keepAliveContainer,this.keepAliveState=F.KEEP_ALIVE_HIDDEN,ze("appstate-change",this.name,{appState:"afterhidden"}),qe(e,this.name,W.AFTERHIDDEN)}showKeepAliveApp(e){ze("appstate-change",this.name,{appState:"beforeshow"}),qe(e,this.name,W.BEFORESHOW),O(this.container,e,!1),this.container=e,this.keepAliveState=F.KEEP_ALIVE_SHOW,ze("appstate-change",this.name,{appState:"aftershow"}),qe(this.container,this.name,W.AFTERSHOW)}onerror(e){qe(this.container,this.name,W.ERROR,e)}getAppState(){return this.state}getKeepAliveState(){return this.keepAliveState}getUmdLibraryHooks(){var e,t;if(k.UNMOUNT!==this.state){const n=null!==(t=null===(e=this.sandBox)||void 0===e?void 0:e.proxyWindow)&&void 0!==t?t:_e.rawWindow;return this.libraryName=L(this.container).getAttribute("library")||`micro-app-${this.name}`,"object"==typeof n[this.libraryName]?n[this.libraryName]:{}}return{}}}function Xe(e){class n extends HTMLElement{constructor(){super(),this.isWaiting=!1,this.cacheData=null,this.hasConnected=!1,this.appName="",this.appUrl="",this.ssrUrl="",this.version=t,this.handleAttributeUpdate=()=>{this.isWaiting=!1;const e=g(this.getAttribute("name")),t=b(this.getAttribute("url"),this.appName);if(this.legalAttribute("name",e)&&this.legalAttribute("url",t)){const n=Qe.get(e);if(e!==this.appName&&n&&k.UNMOUNT!==n.getAppState()&&F.KEEP_ALIVE_HIDDEN!==n.getKeepAliveState()&&!n.isPrefetch)return this.setAttribute("name",this.appName),m(`app name conflict, an app named ${e} is running`,this.appName);e===this.appName&&t===this.appUrl||(e===this.appName?this.handleUnmount(!0,(()=>{this.actionsForAttributeChange(e,t,n)})):this.getKeepAliveModeResult()?(this.handleHiddenKeepAliveApp(),this.actionsForAttributeChange(e,t,n)):this.handleUnmount(this.getDestroyCompatibleResult(),(()=>{this.actionsForAttributeChange(e,t,n)})))}else e!==this.appName&&this.setAttribute("name",this.appName)},ue||(ue=!0,Element.prototype.setAttribute=function(e,t){if(/^micro-app(-\S+)?/i.test(this.tagName)&&"data"===e)if(c(t)){const e={};Object.getOwnPropertyNames(t).forEach((n=>{i(n)&&0===n.indexOf("__")||(e[n]=t[n])})),this.data=e}else"[object Object]"!==t&&f("property data must be an object",this.getAttribute("name"));else if((("src"===e||"srcset"===e)&&/^(img|script)$/i.test(this.tagName)||"href"===e&&/^link$/i.test(this.tagName))&&this.__MICRO_APP_NAME__&&Qe.has(this.__MICRO_APP_NAME__)){const n=Qe.get(this.__MICRO_APP_NAME__);_e.rawSetAttribute.call(this,e,y(t,n.url))}else _e.rawSetAttribute.call(this,e,t)})}static get observedAttributes(){return["name","url"]}connectedCallback(){this.hasConnected=!0,_((()=>qe(this,this.appName,W.CREATED))),this.initialMount()}disconnectedCallback(){this.hasConnected=!1,this.getKeepAliveModeResult()?this.handleHiddenKeepAliveApp():this.handleUnmount(this.getDestroyCompatibleResult())}attributeChangedCallback(e,t,n){if(this.legalAttribute(e,n)&&this[e===T.NAME?"appName":"appUrl"]!==n)if(e!==T.URL||this.appUrl)if(e!==T.NAME||this.appName)this.isWaiting||(this.isWaiting=!0,_(this.handleAttributeUpdate));else{const e=g(n);if(!e)return m(`Invalid attribute name ${n}`,this.appName);this.cacheData&&(st.setData(e,this.cacheData),this.cacheData=null),this.appName=e,e!==n&&this.setAttribute("name",this.appName),this.handleInitialNameAndUrl()}else{if(!(n=b(n,this.appName)))return m(`Invalid attribute url ${n}`,this.appName);this.appUrl=n,this.handleInitialNameAndUrl()}}handleInitialNameAndUrl(){this.hasConnected&&this.initialMount()}initialMount(){if(this.appName&&this.appUrl)if(this.getDisposeResult("shadowDOM")&&!this.shadowRoot&&o(this.attachShadow)&&this.attachShadow({mode:"open"}),this.getDisposeResult("ssr")?this.ssrUrl=y(_e.rawWindow.location.pathname,this.appUrl):this.ssrUrl&&(this.ssrUrl=""),Qe.has(this.appName)){const e=Qe.get(this.appName),t=e.ssrUrl||e.url,n=this.ssrUrl||this.appUrl;e.getKeepAliveState()===F.KEEP_ALIVE_HIDDEN&&e.url===this.appUrl?this.handleShowKeepAliveApp(e):t!==n||!e.isPrefetch&&e.getAppState()!==k.UNMOUNT?e.isPrefetch||e.getAppState()===k.UNMOUNT?(f(`the ${e.isPrefetch?"prefetch":"unmounted"} app with url: ${t} is replaced by a new app`,this.appName),this.handleCreateApp()):m(`app name conflict, an app named ${this.appName} is running`,this.appName):this.handleAppMount(e)}else this.handleCreateApp()}actionsForAttributeChange(e,t,n){var s;this.getDisposeResult("ssr")?this.ssrUrl=y(_e.rawWindow.location.pathname,t):this.ssrUrl&&(this.ssrUrl=""),this.appName=e,this.appUrl=t,(null!==(s=this.shadowRoot)&&void 0!==s?s:this).innerHTML="",e!==this.getAttribute("name")&&this.setAttribute("name",this.appName),n?n.getKeepAliveState()===F.KEEP_ALIVE_HIDDEN?n.url===this.appUrl?this.handleShowKeepAliveApp(n):m(`app name conflict, an app named ${this.appName} is running`,this.appName):n.url===this.appUrl&&n.ssrUrl===this.ssrUrl?this.handleAppMount(n):this.handleCreateApp():this.handleCreateApp()}legalAttribute(e,t){return!(!i(t)||!t)||(m(`unexpected attribute ${e}, please check again`,this.appName),!1)}handleAppMount(e){e.isPrefetch=!1,_((()=>{var t;return e.mount(null!==(t=this.shadowRoot)&&void 0!==t?t:this,this.getDisposeResult("inline"),this.getBaseRouteCompatible())}))}handleCreateApp(){var e;Qe.has(this.appName)&&Qe.get(this.appName).actionsForCompletelyDestroy();const t=new Je({name:this.appName,url:this.appUrl,ssrUrl:this.ssrUrl,container:null!==(e=this.shadowRoot)&&void 0!==e?e:this,inline:this.getDisposeResult("inline"),scopecss:!(this.getDisposeResult("disableScopecss")||this.getDisposeResult("shadowDOM")),useSandbox:!this.getDisposeResult("disableSandbox"),baseroute:this.getBaseRouteCompatible()});Qe.set(this.appName,t)}handleUnmount(e,t){const n=Qe.get(this.appName);n&&n.getAppState()!==k.UNMOUNT&&n.unmount(e,t)}handleHiddenKeepAliveApp(){const e=Qe.get(this.appName);e&&e.getAppState()!==k.UNMOUNT&&e.getKeepAliveState()!==F.KEEP_ALIVE_HIDDEN&&e.hiddenKeepAliveApp()}handleShowKeepAliveApp(e){_((()=>{var t;return e.showKeepAliveApp(null!==(t=this.shadowRoot)&&void 0!==t?t:this)}))}getDisposeResult(e){return(this.compatibleSpecialProperties(e)||st[e])&&this.compatibleDisableSpecialProperties(e)}compatibleSpecialProperties(e){return"disableScopecss"===e?this.hasAttribute("disableScopecss")||this.hasAttribute("disable-scopecss"):"disableSandbox"===e?this.hasAttribute("disableSandbox")||this.hasAttribute("disable-sandbox"):this.hasAttribute(e)}compatibleDisableSpecialProperties(e){return"disableScopecss"===e?"false"!==this.getAttribute("disableScopecss")&&"false"!==this.getAttribute("disable-scopecss"):"disableSandbox"===e?"false"!==this.getAttribute("disableSandbox")&&"false"!==this.getAttribute("disable-sandbox"):"false"!==this.getAttribute(e)}getBaseRouteCompatible(){var e,t;return null!==(t=null!==(e=this.getAttribute("baseroute"))&&void 0!==e?e:this.getAttribute("baseurl"))&&void 0!==t?t:""}getDestroyCompatibleResult(){return this.getDisposeResult("destroy")||this.getDisposeResult("destory")}getKeepAliveModeResult(){return this.getDisposeResult("keep-alive")&&!this.getDestroyCompatibleResult()}set data(e){this.appName?st.setData(this.appName,e):this.cacheData=e}get data(){return this.appName?st.getData(this.appName,!0):this.cacheData?this.cacheData:null}}window.customElements.define(e,n)}function Ye(e){if(!n)return m("preFetch is only supported in browser environment");v((()=>{o(e)&&(e=e()),a(e)&&e.reduce(((e,t)=>e.then((()=>{return e=t,new Promise((t=>{v((()=>{var n,s;if(c(e)&&navigator.onLine)if(e.name=g(e.name),e.url=b(e.url,e.name),e.name&&e.url&&!Qe.has(e.name)){const i=new Je({name:e.name,url:e.url,scopecss:!(null!==(n=e.disableScopecss)&&void 0!==n?n:st.disableScopecss),useSandbox:!(null!==(s=e.disableSandbox)&&void 0!==s?s:st.disableSandbox)});i.isPrefetch=!0,i.prefetchResolve=t,Qe.set(e.name,i)}else t();else t()}))}));var e}))),Promise.resolve())}))}function Ze(e,t,n){if(a(e)){const s=e.filter((e=>i(e)&&e.includes(`.${t}`)&&!n.has(e)));E(s.map((e=>B(e))),(e=>{const t=s[e.index];n.has(t)||n.set(t,e.data)}),(e=>{m(e)}))}}function et(e){const t=[];return Qe.forEach(((n,s)=>{k.UNMOUNT===n.getAppState()||n.isPrefetch||e&&F.KEEP_ALIVE_HIDDEN===n.getKeepAliveState()||t.push(s)})),t}function tt(e,t){const n=Qe.get(g(e));return new Promise((s=>{if(n)if(n.getAppState()===k.UNMOUNT||n.isPrefetch)(null==t?void 0:t.destroy)&&n.actionsForCompletelyDestroy(),s();else if(n.getKeepAliveState()===F.KEEP_ALIVE_HIDDEN)(null==t?void 0:t.destroy)?n.unmount(!0,s):(null==t?void 0:t.clearAliveState)?n.unmount(!1,s):s();else{const e=L(n.container),i=()=>{e.removeEventListener("unmount",i),e.removeEventListener("afterhidden",r),s()},r=()=>{e.removeEventListener("unmount",i),e.removeEventListener("afterhidden",r),s()};if(e.addEventListener("unmount",i),e.addEventListener("afterhidden",r),null==t?void 0:t.destroy){let t,n;e.hasAttribute("destroy")&&(t=e.getAttribute("destroy")),e.hasAttribute("destory")&&(n=e.getAttribute("destory")),e.setAttribute("destroy","true"),e.parentNode.removeChild(e),e.removeAttribute("destroy"),"string"==typeof t&&e.setAttribute("destroy",t),"string"==typeof n&&e.setAttribute("destory",n)}else if((null==t?void 0:t.clearAliveState)&&e.hasAttribute("keep-alive")){const t=e.getAttribute("keep-alive");e.removeAttribute("keep-alive"),e.parentNode.removeChild(e),e.setAttribute("keep-alive",t)}else e.parentNode.removeChild(e)}else f(`app ${e} does not exist`),s()}))}class nt extends Ue{constructor(){super(...arguments),this.tagName="micro-app",this.preFetch=Ye}start(e){if(!n||!window.customElements)return m("micro-app is not supported in this environment");if(null==e?void 0:e.tagName){if(!/^micro-app(-\S+)?/.test(e.tagName))return m(`${e.tagName} is invalid tagName`);this.tagName=e.tagName}if(window.customElements.get(this.tagName))return f(`element ${this.tagName} is already defined`);if(Ae(),e&&c(e)&&(this.shadowDOM=e.shadowDOM,this.destroy=e.destroy,this.destory=e.destory,this.inline=e.inline,this.disableScopecss=e.disableScopecss,this.disableSandbox=e.disableSandbox,this.ssr=e.ssr,o(e.fetch)&&(this.fetch=e.fetch),c(e.lifeCycles)&&(this.lifeCycles=e.lifeCycles),e.preFetchApps&&Ye(e.preFetchApps),e.globalAssets&&(c(t=e.globalAssets)&&v((()=>{Ze(t.js,"js",be),Ze(t.css,"css",Z)}))),o(e.excludeAssetFilter)&&(this.excludeAssetFilter=e.excludeAssetFilter),c(e.plugins))){const t=e.plugins.modules;if(c(t))for(const e in t){const n=g(e);n&&e!==n&&(t[n]=t[e],delete t[e])}this.plugins=e.plugins}var t;Xe(this.tagName)}}var st=new nt;e.EventCenterForMicroApp=xe,e.MicroApp=nt,e.default=st,e.getActiveApps=et,e.getAllApps=function(){return Array.from(Qe.keys())},e.preFetch=Ye,e.pureCreateElement=P,e.removeDomScope=M,e.unmountAllApps=function(e){return Array.from(Qe.keys()).reduce(((t,n)=>t.then((()=>tt(n,e)))),Promise.resolve())},e.unmountApp=tt,e.version=t,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
